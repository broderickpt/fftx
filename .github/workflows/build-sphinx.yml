name: build-sphinx-to-gh-pages

env:
  GITHUB_ACTOR: spiral-software
  GITHUB_REPOSITORY: spiral-software/fftx
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  push:
    branches: [main]

jobs:
  build_sphinx_job:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: install dependencies
        run: |
          set -x
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get -qqq update
          sudo apt-get install -y build-essential ca-certificates cmake pkg-config wget
          sudo apt-get install -y python3.8
          sudo apt-get install -y python3-pip
          pip install -U Sphinx 
          PATH=$PATH:/home/runner/.local/bin
          echo $PATH
          pip install sphinx_rtd_theme 
          pip install breathe
          sudo apt-get install -y doxygen
          sudo curl -L -o /usr/local/bin/cmake-easyinstall https://git.io/JvLxY
          sudo chmod a+x /usr/local/bin/cmake-easyinstall
          export CEI_SUDO="sudo"

      - name: Clone repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/checkout@v2
        with:
          path: fftx

      - name: build the docs
        run: |
          set -x
          PATH=$PATH:/home/runner/.local/bin
          echo $PATH
          cd fftx
          mkdir build && cd build
          cmake ..
          make Sphinx
        shell: bash

      - name: Run build script for Sphinx pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          "${{ github.workspace }}/fftx/docs/buildsite.sh"
        shell: bash
